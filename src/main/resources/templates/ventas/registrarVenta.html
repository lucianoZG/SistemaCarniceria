<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Registrar venta</title>
        <meta charset="UTF-8">
        <!--<link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            .tab-buttons {
                display: flex;
                justify-content: space-around;
                background-color: #f1f1f1;
                border-radius: 25px;
                padding: 5px;
                margin-bottom: 20px;
            }
            .tab-buttons a {
                flex: 1;
                border: none;
                background: none;
                padding: 10px;
                border-radius: 20px;
                font-weight: 500;
                text-align: center;
                text-decoration: none;
                color: #000;
                transition: background-color 0.2s;
            }
            .tab-buttons a:hover {
                background-color: #e5e5e5;
            }
            .tab-buttons .active {
                background-color: #e7e7f7;
                color: #333;
            }
            .table-container {
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 0 8px rgba(0,0,0,0.05);
            }
            .badge-success {
                background-color: #e7f5ff;
                color: #0d6efd;
            }
            .badge-warning {
                background-color: #fff3cd;
                color: #856404;
            }
            body {
                background: linear-gradient(180deg, #ffffff 0%, #fff1f1 40%, #ffe5e5 100%);
            }

        </style>
    </head>
    <body class="d-flex flex-column min-vh-100 bg-light">
        <div th:replace="fragments/navbar :: navbar('ventas')"></div>

        <div class="container mt-4 mb-5">
            <h2 class="fw-bold">Gestión de Ventas</h2>
            <p class="text-muted">Consulta y administra las ventas realizadas en la carnicería</p>

            <!-- Pestañas -->
            <div class="tab-buttons">
                <a th:href="@{/ventas}" class="">Lista de Ventas</a>
                <a th:href="@{/ventas/registrar}" class="active">Registrar Venta</a>
            </div>

            <!-- Contenedor blanco -->
            <div class="table-container">
                <h5 class="mb-4 text-center"><i class="bi bi-cart-plus"></i> Registrar Venta</h5>

                <form th:action="@{/ventas/registrar}" th:object="${venta}" method="post" id="ventaForm">

                    <!-- Empleado -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Empleado</label>
                        <select class="form-select" th:field="*{empleado}">
                            <option th:each="emp : ${empleados}" th:value="${emp.id}" th:text="${emp.nombre}"></option>
                        </select>
                    </div>

                    <!-- Cliente -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cliente</label>
                        <select class="form-select" th:field="*{usuario}">
                            <option th:each="us : ${usuarios}" th:value="${us.id}" th:text="${us.username}"></option>
                        </select>
                    </div>

                    <h5 class="fw-bold mt-4">Agregar Productos</h5>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <select class="form-select" id="productoSelect">
                                <option th:each="prod : ${productos}" 
                                        th:value="${prod.id}" 
                                        th:data-precio="${prod.precioUnitario}"
                                        th:data-precioCosto="${prod.precioCosto}" 
                                        th:data-stock="${prod.stock}"
                                        th:text="${prod.descripcion}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="number" id="cantidadInput" class="form-control" placeholder="Cantidad" min="1" step="0.1">
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-success w-100" onclick="verificarStockAntesDeAgregar()">Agregar</button>
                        </div>
                    </div>

                    <div id="mensajeError" class="alert alert-danger mt-2" style="display:none;"></div>

                    <table class="table table-bordered mt-3">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Subtotal</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="detalleTable"></tbody>
                    </table>

                    <div class="text-end fw-bold fs-5">
                        Total: $<span id="totalVenta">0.00</span>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 mt-3">Registrar Venta</button>
                </form>
            </div>
        </div>



        <script>
            let total = 0;

            function verificarStockAntesDeAgregar() {
                const select = document.getElementById("productoSelect");
                const productoId = select.value;
                const cantidad = parseFloat(document.getElementById("cantidadInput").value);
                const stock = parseFloat(select.options[select.selectedIndex].dataset.stock);


                if (!cantidad || cantidad <= 0) {
                    mostrarError("Ingrese una cantidad válida.");
                    return;
                }

                if (cantidad > stock) {
                    mostrarError(`Stock insuficiente. Disponible: ${stock}`);
                    return;
                }

                ocultarError();
                agregarProducto(); // Solo se agrega si pasa la verificación

                // ✅ Llamada AJAX al endpoint de verificación
//                fetch(`/ventas/verificarStock?productoId=${productoId}&cantidad=${cantidad}`)
//                        .then(response => {
//                            if (!response.ok) {
//                                return response.text().then(msg => {
//                                    throw new Error(msg);
//                                });
//                            }
//                            return response.text();
//                        })
//                        .then(() => {
//                            ocultarError();
//                            agregarProducto(); // Solo se agrega si pasa la verificación
//                        })
//                        .catch(error => {
//                            mostrarError(error.message);
//                        });
            }

            function mostrarError(mensaje) {
                const div = document.getElementById("mensajeError");
                div.innerText = mensaje;
                div.style.display = "block";
            }

            function ocultarError() {
                const div = document.getElementById("mensajeError");
                div.style.display = "none";
            }



            function agregarProducto() {
                const select = document.getElementById('productoSelect');
                const cantidad = parseFloat(document.getElementById('cantidadInput').value);
                const precio = parseFloat(select.options[select.selectedIndex].dataset.precio);
                const descripcion = select.options[select.selectedIndex].text;
                const precioCosto = parseFloat(select.options[select.selectedIndex].dataset.precioCosto);

                if (!cantidad || cantidad <= 0)
                    return alert('Ingrese una cantidad válida.');

                const subtotal = precio * cantidad;
                total += subtotal;
                document.getElementById('totalVenta').textContent = total.toFixed(2);

                const tabla = document.getElementById('detalleTable');
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${descripcion}</td>
                    <td>${cantidad}</td>
                    <td>${precio.toFixed(2)}</td>
                    <td>${subtotal.toFixed(2)}</td>
                    
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); actualizarTotal();">Quitar</button></td>
                    <input type="hidden" name="listaVentaDetalle[${tabla.rows.length}].producto.id" value="${select.value}" />
                    <input type="hidden" name="listaVentaDetalle[${tabla.rows.length}].totalCantidad" value="${cantidad}" />
                    <input type="hidden" name="listaVentaDetalle[${tabla.rows.length}].precioUnitActual" value="${precio}" />
                    <input type="hidden" name="listaVentaDetalle[${tabla.rows.length}].precioCostoActual" value="${precioCosto}" />
                `;
                tabla.appendChild(fila);

                // Actualizar total en un input oculto
                let totalInput = document.getElementById('totalInput');
                if (!totalInput) {
                    totalInput = document.createElement('input');
                    totalInput.type = 'hidden';
                    totalInput.id = 'totalInput';
                    totalInput.name = 'precioTotal';
                    document.getElementById('ventaForm').appendChild(totalInput);
                }
                totalInput.value = total.toFixed(2);
            }

            function actualizarTotal() {
                total = 0;
                const filas = document.querySelectorAll('#detalleTable tr');
                filas.forEach(fila => {
                    const subtotal = parseFloat(fila.cells[3].textContent);
                    total += subtotal;
                });
                document.getElementById('totalVenta').textContent = total.toFixed(2);
                document.getElementById('totalInput').value = total.toFixed(2);
            }
        </script>

        <footer class="mt-auto">
            <div th:replace="fragments/footer :: footer"></div>
        </footer>
    </body>
</html>
