<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <title>Consultas de Ventas</title>
        <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

        <style>
            .tab-buttons {
                display: flex;
                justify-content: space-around;
                background-color: #f1f1f1;
                border-radius: 25px;
                padding: 5px;
                margin-bottom: 20px;
            }
            .tab-buttons a {
                flex: 1;
                text-align: center;
                padding: 10px;
                border-radius: 20px;
                text-decoration: none;
                font-weight: 500;
                color: #333;
                transition: background-color 0.2s;
            }
            .tab-buttons a.active {
                background-color: #e7e7f7;
            }
            .table-container {
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 0 8px rgba(0,0,0,0.05);
            }
            .venta-card {
                border: 1px solid #ddd;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 20px;
                background-color: #fafafa;
            }
            .venta-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            .total-venta {
                text-align: right;
                font-weight: bold;
                color: #0d6efd;
            }
        </style>
    </head>

    <body class="d-flex flex-column min-vh-100">

        <!-- Navbar -->
        <div th:replace="fragments/navbar :: navbar('informes')"></div>

        <div class="container mt-4 mb-5">
            <h2 class="fw-bold">Informes y Consultas</h2>
            <p class="text-muted">Consulta reportes de stock, ventas y ganancias</p>

            <!-- Pestañas -->
            <div class="tab-buttons">
                <a th:href="@{/informes/stock}">Informes de Stock</a>
                <a th:href="@{/informes/consultaVentas}" class="active">Consultas de Ventas</a>
            </div>

            <!-- Filtro de fechas -->
            <div class="table-container mb-4">
                <h5><i class="bi bi-calendar-range"></i> Consultar Ventas por Período</h5>
                <form th:action="@{/informes/consultaVentas}" method="get" class="row g-3 align-items-end">
                    <div class="col-md-5">
                        <label for="fechaInicio" class="form-label">Fecha Desde</label>
                        <input type="date" id="fechaInicio" name="fechaInicio" class="form-control" 
                               th:value="${fechaInicio}">
                    </div>
                    <div class="col-md-5">
                        <label for="fechaFin" class="form-label">Fecha Hasta</label>
                        <input type="date" id="fechaFin" name="fechaFin" class="form-control" 
                               th:value="${fechaFin}">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Buscar</button>
                    </div>
                </form>
            </div>

            <!--            <script>
                            document.addEventListener("DOMContentLoaded", function () {
                                const desde = document.getElementById("fechaDesde");
                                const hasta = document.getElementById("fechaHasta");
            
                                desde.addEventListener("change", function () {
                                    hasta.min = desde.value; // no permite elegir un valor menor
                                });
            
                                hasta.addEventListener("change", function () {
                                    if (hasta.value < desde.value) {
                                        alert("La fecha 'hasta' no puede ser anterior a la fecha 'desde'");
                                        hasta.value = "";
                                    }
                                });
                            });
                        </script>-->

            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>


            <!-- Listado de ventas -->
            <div class="table-container">
                <h5 class="mb-3"><i class="bi bi-receipt"></i> Ventas Encontradas</h5>

                <div th:if="${ventas != null and #lists.isEmpty(ventas)}" class="text-center text-muted">
                    No se encontraron ventas para el período seleccionado.
                </div>

                <div th:each="venta : ${ventas}" class="venta-card">
                    <div class="venta-header">
                        <div>
                            <strong>Factura N°:</strong> <span th:text="${venta.nroFactura}"></span> <br>
                            <small class="text-muted" th:text="${#temporals.format(venta.fechaHora, 'dd/MM/yyyy HH:mm')}"></small>
                        </div>
                        <div>
                            <strong>Total Venta:</strong>
                            <span class="text-success">$</span><span class="text-success" 
                                                                     th:text="${#numbers.formatDecimal(venta.precioTotal, 1, 'COMMA', 0, 'POINT')}"></span>
                        </div>
                    </div>

                    <!-- Tabla de detalles -->
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Precio Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="det : ${venta.listaVentaDetalle}">
                                <td th:text="${det.producto.descripcion}"></td>
                                <td th:text="${det.totalCantidad}"></td>
                                <td th:text="${#numbers.formatDecimal(det.precioUnitActual, 1, 'COMMA', 0, 'POINT')}"></td>
                                <td th:text="${#numbers.formatDecimal(det.precioTotalProducto, 1, 'COMMA', 0, 'POINT')}"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="total-venta">
                        Total Venta: $<span th:text="${#numbers.formatDecimal(venta.precioTotal, 1, 'COMMA', 0, 'POINT')}"></span>
                    </div>
                </div>
            </div>

            <!-- Total general -->
            <div class="text-end mt-3" th:if="${ventas != null and !ventas.isEmpty()}">
                <h5>Total general: 
                    <span class="fw-bold" 
                          th:text="${#numbers.formatDecimal(totalGeneral, 1, 'COMMA', 2, 'POINT')}">
                    </span>
                </h5>
            </div>

        </div>



        <!-- Footer -->
        <div th:replace="fragments/footer :: footer"></div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
