<!-- reemplaza tu template "informes/ganancias.html" por esto -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <title>Informe de Ganancias</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
        <style>
            .tab-buttons {
                display: flex;
                justify-content: space-around;
                background-color: #f1f1f1;
                border-radius: 25px;
                padding: 5px;
                margin-bottom: 20px;
            }
            .tab-buttons a {
                flex: 1;
                text-align: center;
                padding: 10px;
                border-radius: 20px;
                text-decoration: none;
                font-weight: 500;
                color: #333;
                transition: background-color 0.2s;
            }
            .tab-buttons a:hover {
                background-color: #e5e5e5;
            }
            .tab-buttons a.active {
                background-color: #e7e7f7;
            }

            body {
                background: linear-gradient(180deg, #ffffff 0%, #fff1f1 40%, #ffe5e5 100%);
            }


        </style>
    </head>
    <body class="d-flex flex-column min-vh-100">
        <div th:replace="fragments/navbar :: navbar('informes')"></div>

        <div class="container mt-4 mb-5">
            <h2 class="fw-bold">Informe de Ganancias</h2>
            <p class="text-muted">Seleccioná producto (o Todos) y un período opcional</p>

            <!-- Pestañas -->
            <div class="tab-buttons">
                <a th:href="@{/informes/stock}">Informes de Stock</a>
                <a th:href="@{/informes/consultaVentas}">Consultas de Ventas</a>
                <a th:href="@{/informes/ganancias}" class="active">Informe de Ganancias</a>
            </div>

            <div class="card p-3 mb-4">
                <form method="get" th:action="@{/informes/ganancias}" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Producto</label>
                        <select name="productoId" class="form-select">
                            <option value="0">-- Todos los productos --</option>
                            <option th:each="p : ${productos}" th:value="${p.id}" th:text="${p.descripcion}"
                                    th:selected="${productoSeleccionado != null and productoSeleccionado.id == p.id}">
                            </option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Fecha Inicio</label>
                        <input type="date" name="fechaInicio" class="form-control" th:value="${fechaInicio}">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Fecha Fin</label>
                        <input type="date" name="fechaFin" class="form-control" th:value="${fechaFin}">
                    </div>

                    <div class="col-md-2">
                        <button type="submit" class="btn btn-danger w-100">Consultar</button>
                    </div>
                </form>
            </div>

            <!-- Si se eligió un producto específico -->
            <div th:if="${productoSeleccionado != null}">
                <div class="card p-3 mb-3">
                    <h5>Producto: <span th:text="${productoSeleccionado.descripcion}"></span></h5>
                    <p>Ganancia Total: 
                        <span class="fw-bold text-success" th:text="${#numbers.formatDecimal(gananciaTotal, 1, 'COMMA', 2, 'POINT')}"></span>
                    </p>
                    <!-- Opcional: detalle por ventas del producto -->
                    <div th:if="${detallesProducto != null}">
                        <h6>Detalles (ventas que incluyen el producto):</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead><tr><th>Fecha</th><th>Ganancia</th></tr></thead>
                                <tbody>
                                    <tr th:each="d : ${detallesProducto}">
                                        <td th:text="${#temporals.format(d.venta.fechaHora, 'dd/MM/yyyy HH:mm')}"></td>
                                        <td th:text="${#numbers.formatDecimal(d.precioTotalProducto - (d.totalCantidad * d.precioCostoActual), 1, 'COMMA', 2, 'POINT')}"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end mb-4">
                    <a th:href="@{/informes/ganancias/pdf(
                       productoId=${productoSeleccionado.id},
                       fechaInicio=${fechaInicio}, 
                       fechaFin=${fechaFin})}"
                       class="btn btn-danger">
                        <i class="bi bi-file-earmark-pdf-fill"></i> Descargar PDF
                    </a>
                </div>

            </div>

            <!-- Si se eligió "Todos" o no se seleccionó producto: mostrar resumen por producto -->
            <div th:if="${resumenPorProducto != null}">
                <div class="card p-3 mb-3">
                    <h5>Ganancia por Producto</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light"><tr><th>Producto</th><th>Ganancia</th></tr></thead>
                            <tbody>
                                <tr th:each="row : ${resumenPorProducto}">
                                    <td th:text="${row.producto.descripcion}"></td>
                                    <td th:text="${#numbers.formatDecimal(row.ganancia, 1, 'COMMA', 2, 'POINT')}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Ventas incluidas: <span th:text="${ventasPeriodoCount}"></span></small>
                        </div>
                        <div>
                            <strong>Total de ganancia: </strong>
                            <span class="text-success fw-bold" th:text="${#numbers.formatDecimal(gananciaPeriodo, 1, 'COMMA', 2, 'POINT')}"></span>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end mb-4">
                    <a th:href="@{/informes/ganancias/pdf(fechaInicio=${fechaInicio}, fechaFin=${fechaFin})}" class="btn btn-danger">
                        <i class="bi bi-file-earmark-pdf-fill"></i> Descargar PDF
                    </a>
                </div>
            </div>

        </div>

        <div th:replace="fragments/footer :: footer"></div>
    </body>
</html>
